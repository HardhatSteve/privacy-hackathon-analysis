'use client';

import { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { ChevronDown, ChevronUp, AlertTriangle, ExternalLink } from 'lucide-react';
import { cn } from '@/lib/utils';

interface Vulnerability {
  id: string;
  title: string;
  description: string;
  severity: string;
  category: string;
  impact: string;
  recommendation: string;
  cweId?: string;
  confidence: number;
}

interface VulnerabilityStats {
  critical: number;
  high: number;
  medium: number;
  low: number;
}

interface VulnerabilityListProps {
  vulnerabilities: Vulnerability[];
  stats: VulnerabilityStats;
}

const severityOrder = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO'];
const severityVariants: Record<string, any> = {
  CRITICAL: 'critical',
  HIGH: 'high',
  MEDIUM: 'medium',
  LOW: 'low',
  INFO: 'info',
};

const categoryLabels: Record<string, string> = {
  PII_EXPOSURE: 'PII Exposure',
  TIMING_ATTACK: 'Timing Attack',
  STATE_LEAKAGE: 'State Leakage',
  ACCESS_CONTROL: 'Access Control',
  CRYPTOGRAPHIC: 'Cryptographic',
  SIDE_CHANNEL: 'Side Channel',
};

export function VulnerabilityList({ vulnerabilities, stats }: VulnerabilityListProps) {
  const [filter, setFilter] = useState<string>('all');
  const [expandedIds, setExpandedIds] = useState<Set<string>>(new Set());

  const filteredVulns = vulnerabilities
    .filter((v) => filter === 'all' || v.severity === filter.toUpperCase())
    .sort((a, b) => severityOrder.indexOf(a.severity) - severityOrder.indexOf(b.severity));

  const toggleExpanded = (id: string) => {
    const newExpanded = new Set(expandedIds);
    if (newExpanded.has(id)) {
      newExpanded.delete(id);
    } else {
      newExpanded.add(id);
    }
    setExpandedIds(newExpanded);
  };

  return (
    <div className="space-y-4">
      {/* Stats Bar */}
      <div className="flex flex-wrap items-center gap-2">
        <div className="flex items-center gap-1 rounded-md bg-red-100 px-2 py-1 text-sm dark:bg-red-900/30">
          <span className="font-medium text-red-800 dark:text-red-400">
            {stats.critical}
          </span>
          <span className="text-red-600 dark:text-red-400">Critical</span>
        </div>
        <div className="flex items-center gap-1 rounded-md bg-orange-100 px-2 py-1 text-sm dark:bg-orange-900/30">
          <span className="font-medium text-orange-800 dark:text-orange-400">
            {stats.high}
          </span>
          <span className="text-orange-600 dark:text-orange-400">High</span>
        </div>
        <div className="flex items-center gap-1 rounded-md bg-yellow-100 px-2 py-1 text-sm dark:bg-yellow-900/30">
          <span className="font-medium text-yellow-800 dark:text-yellow-400">
            {stats.medium}
          </span>
          <span className="text-yellow-600 dark:text-yellow-400">Medium</span>
        </div>
        <div className="flex items-center gap-1 rounded-md bg-blue-100 px-2 py-1 text-sm dark:bg-blue-900/30">
          <span className="font-medium text-blue-800 dark:text-blue-400">
            {stats.low}
          </span>
          <span className="text-blue-600 dark:text-blue-400">Low</span>
        </div>

        <div className="ml-auto">
          <Select value={filter} onValueChange={setFilter}>
            <SelectTrigger className="w-[140px]">
              <SelectValue placeholder="Filter" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Severities</SelectItem>
              <SelectItem value="critical">Critical</SelectItem>
              <SelectItem value="high">High</SelectItem>
              <SelectItem value="medium">Medium</SelectItem>
              <SelectItem value="low">Low</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </div>

      {/* Vulnerability Cards */}
      <div className="space-y-3">
        {filteredVulns.map((vuln) => (
          <Collapsible
            key={vuln.id}
            open={expandedIds.has(vuln.id)}
            onOpenChange={() => toggleExpanded(vuln.id)}
          >
            <Card>
              <CollapsibleTrigger className="w-full">
                <CardHeader className="flex flex-row items-center justify-between p-4">
                  <div className="flex items-center gap-3">
                    <Badge variant={severityVariants[vuln.severity]}>
                      {vuln.severity}
                    </Badge>
                    <div className="text-left">
                      <h4 className="font-medium">{vuln.title}</h4>
                      <p className="text-sm text-muted-foreground">
                        {categoryLabels[vuln.category] || vuln.category}
                      </p>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="text-xs text-muted-foreground">
                      {Math.round(vuln.confidence * 100)}% confidence
                    </span>
                    {expandedIds.has(vuln.id) ? (
                      <ChevronUp className="h-4 w-4" />
                    ) : (
                      <ChevronDown className="h-4 w-4" />
                    )}
                  </div>
                </CardHeader>
              </CollapsibleTrigger>

              <CollapsibleContent>
                <CardContent className="border-t p-4 pt-4">
                  <div className="space-y-4">
                    <div>
                      <h5 className="mb-1 text-sm font-medium">Description</h5>
                      <p className="text-sm text-muted-foreground">
                        {vuln.description}
                      </p>
                    </div>

                    <div>
                      <h5 className="mb-1 text-sm font-medium">Impact</h5>
                      <p className="text-sm text-muted-foreground">{vuln.impact}</p>
                    </div>

                    <div>
                      <h5 className="mb-1 text-sm font-medium">Recommendation</h5>
                      <p className="text-sm text-muted-foreground">
                        {vuln.recommendation}
                      </p>
                    </div>

                    {vuln.cweId && (
                      <div className="flex items-center gap-2">
                        <Badge variant="outline">{vuln.cweId}</Badge>
                        <a
                          href={`https://cwe.mitre.org/data/definitions/${vuln.cweId.replace('CWE-', '')}.html`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="inline-flex items-center gap-1 text-sm text-primary hover:underline"
                        >
                          Learn more <ExternalLink className="h-3 w-3" />
                        </a>
                      </div>
                    )}
                  </div>
                </CardContent>
              </CollapsibleContent>
            </Card>
          </Collapsible>
        ))}

        {filteredVulns.length === 0 && (
          <Card>
            <CardContent className="flex flex-col items-center justify-center py-12">
              <AlertTriangle className="mb-4 h-12 w-12 text-muted-foreground" />
              <p className="text-muted-foreground">
                No vulnerabilities found with the selected filter
              </p>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}
