name: CI

on:
  push:
    branches: [ main, feature/privacy-layer, feature/solana-bridge, 'feature/zksnark-verification', 'feature/compute-layer', 'feature/compute-privacy-integration' ]
  pull_request:
    branches: [ main ]

jobs:
  format-and-lint:
    name: Format & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Check formatting
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all -- --check

      - name: Clippy warnings
        uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: -- -D warnings

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker system prune -af
          sudo apt-get clean
          df -h

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            protobuf-compiler \
            clang \
            libclang-dev \
            cmake \
            libsnappy-dev \
            liblz4-dev \
            libzstd-dev \
            zlib1g-dev \
            libbz2-dev

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "paraloom-ci"

      - name: Build all features
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --all-features

  test-quick:
    name: Quick Test (All Modules)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker system prune -af
          sudo apt-get clean
          df -h

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            protobuf-compiler \
            clang \
            libclang-dev \
            cmake \
            libsnappy-dev \
            liblz4-dev \
            libzstd-dev \
            zlib1g-dev \
            libbz2-dev

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "paraloom-ci"

      - name: Run all tests (quick check)
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --lib --all-features
        env:
          CARGO_INCREMENTAL: 0

  test:
    name: Test (${{ matrix.module }})
    runs-on: ubuntu-latest
    needs: test-quick
    strategy:
      fail-fast: false
      matrix:
        module:
          - privacy
          - compute
          - storage
          - network
          - consensus
    steps:
      - uses: actions/checkout@v3

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker system prune -af
          sudo apt-get clean
          df -h

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            protobuf-compiler \
            clang \
            libclang-dev \
            cmake \
            libsnappy-dev \
            liblz4-dev \
            libzstd-dev \
            zlib1g-dev \
            libbz2-dev

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "paraloom-ci"

      - name: Run module tests (thread-safe)
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --lib ${{ matrix.module }} --all-features -- --test-threads=1

  test-binaries:
    name: Test Binaries
    runs-on: ubuntu-latest
    needs: test-quick
    steps:
      - uses: actions/checkout@v3

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker system prune -af
          sudo apt-get clean
          df -h

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            protobuf-compiler \
            clang \
            libclang-dev \
            cmake \
            libsnappy-dev \
            liblz4-dev \
            libzstd-dev \
            zlib1g-dev \
            libbz2-dev

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "paraloom-ci"

      - name: Build setup ceremony binary
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --bin setup_compute_ceremony

      - name: Build all binaries
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --bins

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [test, test-binaries]
    if: false # Disabled due to RAM limitations on free runners
    steps:
      - uses: actions/checkout@v3

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker system prune -af
          sudo apt-get clean
          df -h

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            protobuf-compiler \
            clang \
            libclang-dev \
            cmake \
            libsnappy-dev \
            liblz4-dev \
            libzstd-dev \
            zlib1g-dev \
            libbz2-dev

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage report
        run: cargo tarpaulin --out Xml --lib --tests --timeout 300

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./cobertura.xml
          fail_ci_if_error: false
